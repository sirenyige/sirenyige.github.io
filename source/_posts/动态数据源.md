---
title: 动态数据源
date: 2020-03-17 21:58:42
categories:
- 数据库
tags:
- java
---

# 动态数据源
## 一、AbstractRoutingDataSource

AbstractRoutingDataSource类充当了**DataSource的路由中介**, 能有在**运行时**, 根据某种key值来**动态切换**到真正的DataSource上。

![动态数据源](/动态数据源/动态数据源.jpg)

<!-- more -->

Spring对于多数据源，以数据库表为参照，大体上可以分成两大类情况： 
1、表级上的跨数据库。即，对于不同的数据库却有相同的表（表名和表结构完全相同）。 
2、非表级上的跨数据库。即，多个数据源不存在相同的表。 

通过实现抽象方法determineCurrentLookupKey返回预制数据源的key，以便在建立getConnection时选取指定的数据源，需要使用线程变量ThreadLocal进行保存

## 二、工作流程

1、初始化dataSource 映射Map

2、在Mybati拦截器中根据查询条件共同计算得出分库分表信息，并存于ThreadLocal环境变量

3、dataSource的determineCurrentLookupKey获取对应的ThreadLocal环境变量，进行目标DataSource的key值组装，以便在getConnection时可以在初始化的dataSource映射Map中找到对应的dataSource

## 三、具体代码

1、Spring配置DataSourceFactory工厂为datasource bean，工厂类中实例化RoutingDataSource、初始化targetDataSources和defaultTargetDataSource，并调用afterPropertiesSet进行解析写入resolvedDataSources和resolvedDefaultDataSource

2、配置SqlSessionFactoryBean工厂类为sqlSessionFactory，并注入dataSource、mapperLocations和plugins

3、plugins中增加Mybatis拦截器